---
output:
  word_document: default
  pdf_document: default
  html_document:
    keep_md: yes
---

#Bat survey in Plumas National Forest through the use of acoustic bat detectors
###author: Derek Corcoran
####Last update: `r Sys.Date() `
```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

```{r, message=FALSE, warning=FALSE, echo=FALSE,results='hide'}
library("raster", lib.loc="~/R/win-library/3.2")
library("rasterVis", lib.loc="~/R/win-library/3.2")
library("maps", lib.loc="~/R/win-library/3.2")
library("maptools", lib.loc="~/R/win-library/3.2")
library("rgdal", lib.loc="~/R/win-library/3.2")
library("latticeExtra", lib.loc="~/R/win-library/3.2")
library("dplyr", lib.loc="~/R/win-library/3.2")
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
PNF<- readGDAL("C:/Users/usuario/Bats_California/layers/PNF.asc")
PNF<-raster (PNF)
bc <- readGDAL("C:/Users/usuario/Bats_California/layers/burn_canopy.asc")
bc<-raster (bc)
bb <- readGDAL("C:/Users/usuario/Bats_California/layers/burn_basal.asc")
bb<-raster (bb)
bs <- readGDAL("C:/Users/usuario/Bats_California/layers/burn_severity.asc")
bs<-raster (bs)
topo <- readGDAL("C:/Users/usuario/Bats_California/layers/plumastopo.asc")
topo<-raster (topo)
Vegetation_existing <- readGDAL("C:/Users/usuario/Bats_California/layers/VegTypeAll.asc")
Vegetation_existing<-raster (Vegetation_existing)
FireReturnAll <- readGDAL("C:/Users/usuario/Bats_California/layers/FireReturnAll.asc")
FireReturnAll<-raster (FireReturnAll)
TreatmentsStorrie <- readGDAL("C:/Users/usuario/Bats_California/layers/TreatmentsStorrie.asc")
TreatmentsStorrie<-raster (TreatmentsStorrie)
FireHistory <- readGDAL("C:/Users/usuario/Bats_California/layers/FireHistory.asc")
FireHistory<-raster (FireHistory)
Goshawkforag <- readGDAL("C:/Users/usuario/Bats_California/layers/Goshawkforag.asc")
Goshawkforag<-raster (Goshawkforag)
GoshawkNEST <- readGDAL("C:/Users/usuario/Bats_California/layers/GoshawkNEST.asc")
GoshawkNEST<-raster (GoshawkNEST)
MartenHabit <- readGDAL("C:/Users/usuario/Bats_California/layers/MartenHabit.asc")
MartenHabit<-raster (MartenHabit)
SeralStage <-readGDAL("C:/Users/usuario/Bats_California/layers/SeralStage.asc")
SeralStage<-raster (SeralStage)
```

```{r, echo=FALSE, results='hide', message=FALSE}
df.bb <- data.frame(id=c(NA,1,2,3,4,5,6,7,255), v=c(0,1,2,3,4,5,6,7,8))#Change outlayers and extract NAs 

bb1 <- subs(bb, df.bb,subswithNA=FALSE)
df.bs <- data.frame(id=c(NA,1,2,3,4,255), v=c(0,1,2,3,4,5))
bs1 <- subs(bs, df.bs,subswithNA=FALSE)
df.bc <- data.frame(id=c(NA,1,2,3,4,5,255), v=c(0,1,2,3,4,5,6))
bc1 <- subs(bc, df.bc,subswithNA=FALSE)
lidar.limit <- readOGR(dsn="C:/Users/usuario/Bats_California/layers",layer="LiDAR_Boundary")
lidar.limit <- spTransform(lidar.limit, CRS("+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"))
```
```{r, echo=FALSE, results='hide', message=FALSE}
bb<-projectRaster(bb1, PNF)
bs<-projectRaster(bs1, PNF)
bc<-projectRaster(bc1, PNF)
Vegetation_existing<-projectRaster(Vegetation_existing, PNF)
FireReturnAll<-projectRaster(FireReturnAll, PNF)
TreatmentsStorrie<-projectRaster(TreatmentsStorrie, PNF)
FireHistory <-projectRaster(FireHistory, PNF)
Goshawkforag <-projectRaster(Goshawkforag,PNF)
GoshawkNEST<- projectRaster(GoshawkNEST, PNF)
MartenHabit<- projectRaster(MartenHabit, PNF)
SeralStage<- projectRaster(SeralStage,PNF)
```
```{r, echo=FALSE, results='hide', message=FALSE}
bc<-resample(bc, PNF)
bb<-resample(bb, PNF)
bs<-resample(bs, PNF)
Vegetation_existing<-resample(Vegetation_existing, PNF, method="ngb")
FireReturnAll<-resample(FireReturnAll, PNF)
TreatmentsStorrie<-resample(TreatmentsStorrie, PNF)
FireHistory<-resample(FireHistory, PNF)
topo<-resample(topo,PNF)
Goshawkforag<-resample(Goshawkforag,PNF, method="ngb")
GoshawkNEST <- resample(GoshawkNEST, PNF, method="ngb")
TreatmentsStorrie[is.na(TreatmentsStorrie)] <- 0
MartenHabit <- resample (MartenHabit, PNF, method="ngb")
SeralStage <- resample (SeralStage, PNF, method="ngb")
```

```{r, echo=FALSE, results='hide',warning=FALSE}
ratify(Vegetation_existing, count=TRUE)
```


```{r,echo=FALSE,warning=FALSE}
FireReturnAll[FireReturnAll < 0] <- NA
```
#Introduction

To study bat occupancy in the Plumas National Forest by surveying acustically different areas of the forest, the three objective species for this survey are the Pallid Bat, the Townsend's Long-eared Bat, and the California Bat. Nevertheless, there is at least 14 species that form the bat ensemble in the National Forest, the list of species is the following

- *Tadarida brasiliensis* â€“ free-tailed Bat
- *Antrozous pallidus* - **Pallid Bat**
- *Eptesicus fuscus* - Big Brown Bat
- *Euderma maculatum* - Spotted Bat
- *Lasionycteris noctivagans* - Silvered-haired Bat
- *Lasiurus blossevillii* - Western Red Bat
- *Lasiurus cinereus* - Hoary Bat
- *Corynorhinus townsendii* - **Townsend's Long-eared Bat**
- *Myotis californicus* - **California Bat**
- *Myotis evotis* - Long-eared Bat
- *Myotis lucifugus* - Little Brown Bat
- *Myotis thysanodes* - Fringed Bat
- *Myotis volans* - Hairy-winged bat
- *Myotis yumanensis* - Yuma myotis

##Objective of the study

To determine the factors that influence bat occupancy in heterogeneous environments of Plumas National Forest, including areas corresponding to the Moonlight Fire and the Storrie Fire. Comparing and complementing biotic and abiotic variables. 

```{r, echo=FALSE, results='hide', warning=FALSE}
roads.v <- readOGR(dsn="C:/Users/usuario/Bats_California/layers",layer="Roads")
roads.v <- spTransform(roads.v, CRS("+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"))
template <- PNF  # this will be the template
template[] <- NA  # assigns all values as NA
roads.r <- rasterize(roads.v, template, field=1)
```

```{r,echo=FALSE, results='hide'}
roaddist.r <- distance(roads.r)
roaddist.r<- roaddist.r*PNF

```

```{r,echo=FALSE}
rivers <- readOGR(dsn="C:/Users/usuario/Bats_California/layers",layer="NHDFlowline")
rivers <- spTransform(rivers, CRS("+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"))
template2 <- PNF  # this will be the template
template2[] <- NA  # assigns all values as NA
rivers.r <- rasterize(rivers, template2, field=1)
riverdist.r <- distance(rivers.r)
riverdist.r<- riverdist.r*PNF

```

# Specific research questions and the factors that might influence them

##1. Which factors affect bat occupancy in burned forest?
        
###Does bat occupancy differ with the duration of time since the fire?

-	Explanatory variable = burn age at sampling sites (mean number of years between fires for a given point and the time till the last fire for a given point).

```{r,echo=FALSE}
burn.age<- stack(FireReturnAll, FireHistory)
names(burn.age)<- c("Fire Interval", "Fire History")
plot(burn.age)
```

###Does bat occupancy differ with burn intensity

- Explanatory variable = burn intensity (in the following figure we see the layers that will allow us to work with burn intensity, this layers are burn intensity of the soil, burn intensity of the canopy, and Burn intensity of the basal area)

```{r, echo=FALSE}
burn<- stack(bs,bc,bb)
names(burn)<-c("Burn soil", "Burn canopy", "Burn basal")
plot(burn)
```

###Does bat occupancy differ with forest type

- Explanatory variable = Stand type 
-	Explanatory variable = Forest type (type of forest typified in SeralStageariabariables = Abiotic variables (Altitud, di
-	Explanatory variable = Historic burn age 

```{r,echo=FALSE, cache=TRUE}

Forest.Type <- stack(Vegetation_existing,SeralStage,FireReturnAll)
names(Forest.Type) <- c("Vegetation Type","Seral Stage", "Fire Interval")
plot(Forest.Type)

```


###Does bat occupancy differ with roost site availability?

- Explanatory variable = Associated forest metrics (Lidar???, distance to water) 

**Concidering that we will work using lidar images, the layers to use will be acquired later, since most of this variables are only presented for del black polygon in the next figure.**


```{r,echo=FALSE}
library("raster", lib.loc="~/R/win-library/3.2")
plot(PNF)
plot(bs, add=TRUE, legend=FALSE)
plot(lidar.limit, add=TRUE, legend=FALSE)
```

##Which factors affect bat occupancy in unburned forest?

- explanatory vstance to road, distance to water)

```{r, echo=FALSE}
abiotic <- stack(roaddist.r, topo, riverdist.r)
names(abiotic)<-c("Road distance", "Altitud", "River distance")
plot(abiotic, colNA="black")
```

##Is occupancy affected by presence of heterospecifics?

###is bat occupancy affected by presence of other bats? (competition)

- Explanatory variable, occupancy of other bats (based on this study)

###is bat occupancy affected by the presence of preys?

- Explanatory variable, athropod emergence (Loren's Study)

###is bat occupancy affected by the presence of predators

- Explanatory variables marten, and spotted owl layers from NFS (Spotted owl habitat foraging and nesting shown as *band 1.1* and *band 1.2* in the next figure and Marten habitat shown as *band 1.3* in the next figure)

```{r,echo=FALSE}
predators<-stack(Goshawkforag, GoshawkNEST, MartenHabit)
names(predators)<- c("Goshawk Habitat f", "Goshawk Habitat n", "Marten Habitat")
plot(predators)
```

#Sampling desing and sampling unit

In order for us to study bat occupancy and to spatially predict it using the factors described in the previous section, most of the diversity of the forest has to be included in the model. To include that variability, I classified the environments using the following layers (Topography, Intervals between fires, Forest Type, Distance to roads, Nesting Habitat quality for Spotted owl, foraging Habitat quality for Spotted owl, Habitat Quality for Marten) **[to be included tomorrow, distance to rivers, and distance to roads/path]**

##Check for correlation between rasters

First will scale every layer so that it goes from 0 to 1, in order for no layer to have more weight in the classification. And then we check the correlation between rasters. in the next graph/table, we see the relationship between our predictive variables. Here we see that we might want to take one of the two habitat quality layers for the Spotted Owl (R=0.74), and since we are using the spoted owl as a potential predator, we will keep the foraging habitat quality.



```{r,cache=FALSE, echo=FALSE, results='asis'}
library("raster", lib.loc="~/R/win-library/3.2")
AllLayers1 <-stack(topo,FireReturnAll,roaddist.r, Vegetation_existing, riverdist.r)
names(AllLayers1)<-c("Altitud","Fire Interval", "Distance Road", "Vegetation Type", "Distance river")
AllLayers2<-AllLayers1*PNF
names(AllLayers2)<-c("Altitud","Fire Interval", "Distance Road", "Seral Stage", "Distance river")
plot (AllLayers2, colNA="black")
pairs(AllLayers2)
rasterRescale<-function(r){
    ((r-cellStats(r,"min"))/(cellStats(r,"max")-cellStats(r,"min")))
}
AllLayers2<-rasterRescale(AllLayers2)
#AllLayers2<-dropLayer(AllLayers2,5)
plot(AllLayers2)
```

#Clasification

Now we will use kmeans to sort the area into 5 types of habitat using the abovementioned rasterstack, and it will be ploted with different colors for every type of environment.


```{r, echo=FALSE,cache=FALSE}
valuetable <- getValues(AllLayers2)
km1 <- kmeans(na.omit(valuetable), centers = 5, iter.max = 100, nstart = 10)
# create a blank raster with default values of 0
rNA <- setValues(raster(AllLayers2), 0)
for(i in 1:nlayers(AllLayers2)){
  rNA[is.na(AllLayers2[[i]])] <- 1
}
# convert rNA to an integer vector
rNA <- getValues(rNA)
# convert valuetable to a data.frame
valuetable <- as.data.frame(valuetable)
# if rNA is a 0, assign the cluster value at that position
valuetable$class[rNA==0] <- km1$cluster
# if rNA is a 1, assign an NA at that position
valuetable$class[rNA==1] <- NA
# create a blank raster
classes1 <- raster(AllLayers2)
# assign values from the 'class' column of valuetable
classes1 <- setValues(classes1, valuetable$class)
plot(classes1, legend=TRUE, colNA="black")
```

More info on how to do this clasification in *https://geoscripting-wur.github.io/AdvancedRasterAnalysis/*

#separate layers acording to places with or without fire

Now we will separate the whole area in two subtypes burned areas and non-buned areas, based on the burn severity layers

```{r, cache=FALSE, echo=FALSE}
df.bs1 <- data.frame(id=c(0,1,2,3,4,5), v=c(NA,1,1,1,1,1))
fire <- subs(bs1, df.bs1,subswithNA=FALSE)
fire<-projectRaster(fire, PNF)

df.bs2 <- data.frame(id=c(NA,1), v=c(1,NA))
not.fire <- subs(fire, df.bs2,subswithNA=FALSE)

classes.with.fire<-classes1*fire
classes.without.fire<-classes1*not.fire

plot(classes.with.fire,colNA="black", main="Classification within burned area")
plot(classes.without.fire,colNA="black",main="Classification within non-burned area")
```

#Extract Random points from each habitat type with equal number in fire and non fire

During the first year of sampling 120 samples will be colected, 60 in burned areas, and 60 in non-burned areas, within each, 12 random points will be sampled in each habtitat type defined by the K-means classification.


- 60 random points in not Fire, 12 random points per each environment type
- 60 random points in Fire, 12 random points per each environment type
- We plot the chosen random points over the topographic map, each color is an environment type, full circles are places where there was no fire, and full triangles, where there was a fire


```{r,cache=FALSE, fig.height=6, fig.width=8, echo=FALSE}
library(rgdal)
set.seed(12)

df.class.1f <- data.frame(id=c(1,2,3,4,5), v=c(1,NA,NA,NA,NA))
class1f <- subs(classes.with.fire, df.class.1f,subswithNA=FALSE)
points1f<-sampleRandom(class1f,12, na.rm=TRUE, xy=TRUE, sp=TRUE)
#newlayers <- dir(path="C:/Users/usuario/Bats_California/new_layers")
#writeOGR(points1f,newlayers,"fire1", driver="ESRI Shapefile")

df.class.1nf <- data.frame(id=c(1,2,3,4,5), v=c(1,NA,NA,NA,NA))
class1nf <- subs(classes.without.fire, df.class.1nf,subswithNA=FALSE)
points1nf<-sampleRandom(class1nf,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.2f <- data.frame(id=c(1,2,3,4,5), v=c(NA,2,NA,NA,NA))
class2f <- subs(classes.with.fire, df.class.2f,subswithNA=FALSE)
points2f<-sampleRandom(class2f,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.2nf <- data.frame(id=c(1,2,3,4,5), v=c(NA,2,NA,NA,NA))
class2nf <- subs(classes.without.fire, df.class.2nf,subswithNA=FALSE)
points2nf<-sampleRandom(class2nf,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.3f <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,3,NA,NA))
class3f <- subs(classes.with.fire, df.class.3f,subswithNA=FALSE)
points3f<-sampleRandom(class3f,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.3nf <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,3,NA,NA))
class3nf <- subs(classes.without.fire, df.class.3nf,subswithNA=FALSE)
points3nf<-sampleRandom(class3nf,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.4f <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,NA,4,NA))
class4f <- subs(classes.with.fire, df.class.4f,subswithNA=FALSE)
points4f<-sampleRandom(class4f,12, na.rm=TRUE, xy=TRUE, sp= TRUE)

df.class.4nf <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,NA,4,NA))
class4nf <- subs(classes.without.fire, df.class.4nf,subswithNA=FALSE)
points4nf<-sampleRandom(class4nf,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.5f <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,NA,NA,5))
class5f <- subs(classes.with.fire, df.class.5f,subswithNA=FALSE)
points5f<-sampleRandom(class5f,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

df.class.5nf <- data.frame(id=c(1,2,3,4,5), v=c(NA,NA,NA,NA,5))
class5nf <- subs(classes.without.fire, df.class.5nf,subswithNA=FALSE)
points5nf<-sampleRandom(class5nf,12, na.rm=TRUE, xy=TRUE, sp=TRUE)

```

```{r, echo=FALSE, cache=FALSE}
library("rasterVis", lib.loc="~/R/win-library/3.2")
topo.park<-(topo*PNF)
arterial<-roads.v[roads.v$FUNCTIONAL=="A - ARTERIAL",]
collector<-roads.v[roads.v$FUNCTIONAL=="C - COLLECTOR",]
local<-roads.v[roads.v$FUNCTIONAL=="L - LOCAL",]
levelplot(topo.park, contour=TRUE, margin=FALSE)+ layer(sp.points(points5nf, col="purple", pch=17))+ layer(sp.points(points5f, col="purple", pch=19))+ layer(sp.points(points4nf, col="brown", pch=17))+ layer(sp.points(points4f, col="brown", pch=19))+ layer(sp.points(points3nf, col="red", pch=17))+ layer(sp.points(points3f, col="red", pch=19))+ layer(sp.points(points2nf, col="blue", pch=17))+ layer(sp.points(points2f, col="blue", pch=19))+ layer(sp.points(points1nf, col="black", pch=17))+ layer(sp.points(points1f, col="black", pch=19))+layer(sp.lines(arterial, col="red", lw=2))+layer(sp.lines(collector, col="red", lw=1, lty=2))

```

###Values

```{r, echo=FALSE,cache=FALSE}
library(dplyr)
df.values<-extract(AllLayers1, points1nf, df=TRUE, method="simple")
df.values<-df.values[,2:6]
df.values<-cbind(points1nf$x, points1nf$y, df.values,rep("1nf", times=12))
colnames(df.values)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values$Long=df.values$Long*-1

df.values1f<-extract(AllLayers1, points1f, df=TRUE, method="simple")
df.values1f<-df.values1f[,2:6]
df.values1f<-cbind(points1f$x, points1f$y, df.values1f,rep("1f", times=12))
colnames(df.values1f)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values1f$Long=df.values1f$Long*-1

df.values2nf<-extract(AllLayers1, points2nf, df=TRUE, method="simple")
df.values2nf<-df.values2nf[,2:6]
df.values2nf<-cbind(points2nf$x, points2nf$y, df.values2nf,rep("2nf", times=12))
colnames(df.values2nf)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values2nf$Long=df.values2nf$Long*-1

df.values2f<-extract(AllLayers1, points2f, df=TRUE, method="simple")
df.values2f<-df.values2f[,2:6]
df.values2f<-cbind(points2f$x, points2f$y, df.values2f,rep("2f", times=12))
colnames(df.values2f)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values2f$Long=df.values2f$Long*-1

df.values3nf<-extract(AllLayers1, points3nf, df=TRUE, method="simple")
df.values3nf<-df.values3nf[,2:6]
df.values3nf<-cbind(points3nf$x, points3nf$y, df.values3nf,rep("3nf", times=12))
colnames(df.values3nf)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values3nf$Long=df.values3nf$Long*-1

df.values3f<-extract(AllLayers1, points3f, df=TRUE, method="simple")
df.values3f<-df.values3f[,2:6]
df.values3f<-cbind(points3f$x, points3f$y, df.values3f,rep("3f", times=12))
colnames(df.values3f)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values3f$Long=df.values3f$Long*-1

df.values4nf<-extract(AllLayers1, points4nf, df=TRUE, method="simple")
df.values4nf<-df.values4nf[,2:6]
df.values4nf<-cbind(points4nf$x, points4nf$y, df.values4nf,rep("4nf", times=12))
colnames(df.values4nf)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values4nf$Long=df.values4nf$Long*-1

df.values4f<-extract(AllLayers1, points4f, df=TRUE, method="simple")
df.values4f<-df.values4f[,2:6]
df.values4f<-cbind(points4f$x, points4f$y, df.values4f,rep("4f", times=12))
colnames(df.values4f)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values4f$Long=df.values4f$Long*-1

df.values5nf<-extract(AllLayers1, points5nf, df=TRUE, method="simple")
df.values5nf<-df.values5nf[,2:6]
df.values5nf<-cbind(points5nf$x, points5nf$y, df.values5nf,rep("5nf", times=12))
colnames(df.values5nf)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values5nf$Long=df.values5nf$Long*-1

df.values5f<-extract(AllLayers1, points5f, df=TRUE, method="simple")
df.values5f<-df.values5f[,2:6]
df.values5f<-cbind(points5f$x, points5f$y, df.values5f,rep("5f", times=12))
colnames(df.values5f)<- c("Long", "Lat","Height","Fire_Interval", "Distance_to_Road", "Sage_Stage", "Distance_to_Water", "ID")
df.values5f$Long=df.values5f$Long*-1

df.values<-rbind(df.values, df.values1f, df.values2nf, df.values2f, df.values3nf, df.values3f, df.values4nf, df.values4f, df.values5nf, df.values5f)

by_group <- group_by(df.values, ID)
by_group <- summarise(by_group, mean(Height), mean(Fire_Interval), mean(Distance_to_Road), mean(Sage_Stage), mean(Distance_to_Water))

library("knitr", lib.loc="~/R/win-library/3.2")

kable(by_group, col.names=c("ID","Height","Fire Interval", "Distance to Road", "Sage Stage", "Distance to Water"), caption="Mean value for every variable for each ID which combines prior classification (1 to 5) and fire or no fire (f or nf)")
```

#Simulated sampling Dynamic modeling

```{r}
library("unmarked", lib.loc="~/R/win-library/3.2")
```

###First we simulate our detection history for 30 sites with four primary sampling periods, and three secondary sampling periods each.
```{r, echo=FALSE}
set.seed(20)
s1.1a<-rbinom(n=10, size=1, prob=0.9)
s1.1b<-rbinom(n=10, size=1, prob=0.4)
s1.1c<-rbinom(n=10, size=1, prob=0.2)
s1.2a<-rbinom(n=10, size=1, prob=0.9)
s1.2b<-rbinom(n=10, size=1, prob=0.4)
s1.2c<-rbinom(n=10, size=1, prob=0.2)
s1.3a<-rbinom(n=10, size=1, prob=0.9)
s1.3b<-rbinom(n=10, size=1, prob=0.4)
s1.3c<-rbinom(n=10, size=1, prob=0.2)

s1.1 <-c(s1.1a,s1.1b,s1.1c)
s1.2 <-c(s1.2a,s1.2b,s1.2c)
s1.3 <-c(s1.3a,s1.3b,s1.3c)

s2.1a<-rbinom(n=10, size=1, prob=0.9)
s2.1b<-rbinom(n=10, size=1, prob=0.4)
s2.1c<-rbinom(n=10, size=1, prob=0.2)
s2.2a<-rbinom(n=10, size=1, prob=0.9)
s2.2b<-rbinom(n=10, size=1, prob=0.4)
s2.2c<-rbinom(n=10, size=1, prob=0.2)
s2.3a<-rbinom(n=10, size=1, prob=0.9)
s2.3b<-rbinom(n=10, size=1, prob=0.4)
s2.3c<-rbinom(n=10, size=1, prob=0.2)

s2.1 <-c(s2.1a,s2.1b,s2.1c)
s2.2 <-c(s2.2a,s2.2b,s2.2c)
s2.3 <-c(s2.3a,s2.3b,s2.3c)

s3.1a<-rbinom(n=10, size=1, prob=0.9)
s3.1b<-rbinom(n=10, size=1, prob=0.4)
s3.1c<-rbinom(n=10, size=1, prob=0.1)
s3.2a<-rbinom(n=10, size=1, prob=0.9)
s3.2b<-rbinom(n=10, size=1, prob=0.4)
s3.2c<-rbinom(n=10, size=1, prob=0.2)
s3.3a<-rbinom(n=10, size=1, prob=0.9)
s3.3b<-rbinom(n=10, size=1, prob=0.4)
s3.3c<-rbinom(n=10, size=1, prob=0.1)

s3.1 <-c(s3.1a,s3.1b,s3.1c)
s3.2 <-c(s3.2a,s3.2b,s3.2c)
s3.3 <-c(s3.3a,s3.3b,s3.3c)

s4.1a<-rbinom(n=10, size=1, prob=0.9)
s4.1b<-rbinom(n=10, size=1, prob=0.4)
s4.1c<-rbinom(n=10, size=1, prob=0.1)
s4.2a<-rbinom(n=10, size=1, prob=0.9)
s4.2b<-rbinom(n=10, size=1, prob=0.4)
s4.2c<-rbinom(n=10, size=1, prob=0.1)
s4.3a<-rbinom(n=10, size=1, prob=0.9)
s4.3b<-rbinom(n=10, size=1, prob=0.4)
s4.3c<-rbinom(n=10, size=1, prob=0.1)

s4.1 <-c(s4.1a,s4.1b,s4.1c)
s4.2 <-c(s4.2a,s4.2b,s4.2c)
s4.3 <-c(s4.3a,s4.3b,s4.3c)
sampling.ocup1<- cbind(s1.1,s1.2,s1.3,s2.1,s2.2,s2.3,s3.1,s3.2,s3.3,s4.1,s4.2,s4.3)
```
```{r,echo=FALSE}
library("knitr", lib.loc="~/R/win-library/3.2")
kable(sampling.ocup1)


```

This simulated data has some underlying characteristics:

**environment a (top 10 rows, the best environment for bats, also occupancy increases with time)**
```{r}
mean(sampling.ocup1[1:10])
```
**environment b (rows 11 to 20, medium environment, occupancy stays the same)**
```{r}
mean(sampling.ocup1[11:20])
```
**environment c (rows 21 to 30) poor environment for bats, also there is extintion)**
```{r}
mean(sampling.ocup1[21:30])
```

Now we will simulate some variables for the site covariates.
###Site cov static
**the more variable 1, the better for bats**

```{r, echo=FALSE}
v.1a<-rnorm(n=10, mean=20, sd=0.7)
v.1b<-rnorm(n=10, mean=10, sd=0.7)
v.1c<-rnorm(n=10, mean=5, sd=0.7)

v.1 <-c(v.1a,v.1b,v.1c)
```

```{r}
mean(v.1[1:10])
mean(v.1[11:20])
mean(v.1[21:30])
```


###the less variable 2 better for bats
```{r,echo=FALSE}
v.2a<-rnorm(n=10, mean=20, sd=0.7)
v.2b<-rnorm(n=10, mean=40, sd=0.7)
v.2c<-rnorm(n=10, mean=60, sd=0.7)

v.2 <-c(v.2a,v.2b,v.2c)
```

```{r}
mean(v.2[1:10])
mean(v.2[11:20])
mean(v.2[21:30])
```

###variable 3 does not mater to bats

```{r,echo=FALSE}
v.3a<-rnorm(n=10, mean=20, sd=0.7)
v.3b<-rnorm(n=10, mean=20, sd=0.7)
v.3c<-rnorm(n=10, mean=20, sd=0.7)


v.3 <-c(v.3a,v.3b,v.3c)
```

```{r}
mean(v.3[1:10])
mean(v.3[11:20])
mean(v.3[21:30])
```

```{r}
sampling.cov<- cbind(v.1,v.2, v.3)
```
###yearly colonization extintion variable

```{r}
temp1<-rnorm(n=30, mean=20, sd=10)
temp2<-rnorm(n=30, mean=40, sd=10)
temp3<-rnorm(n=30, mean=50, sd=10)
temp4<-rnorm(n=30, mean=60, sd=10)


temps <-cbind(temp1,temp2, temp3, temp4)
```
###observer within secondary it could be variable


###observers dont vary in the model, they should all be the same

```{r}
obs1<-rnorm(n=30, mean=40, sd=0.7)
obs2<-rnorm(n=30, mean=40, sd=0.7)
obs3<-rnorm(n=30, mean=40, sd=0.7)
obs4<-rnorm(n=30, mean=40, sd=0.7)
obs5<-rnorm(n=30, mean=40, sd=0.7)
obs6<-rnorm(n=30, mean=40, sd=0.7)
obs7<-rnorm(n=30, mean=40, sd=0.7)
obs8<-rnorm(n=30, mean=40, sd=0.7)
obs9<-rnorm(n=30, mean=40, sd=0.7)
obs10<-rnorm(n=30, mean=40, sd=0.7)
obs11<-rnorm(n=30, mean=40, sd=0.7)
obs12<-rnorm(n=30, mean=40, sd=0.7)

observers1<-data.frame(cbind(obs1,obs2,obs3, obs4, obs5, obs6, obs7, obs8, obs9, obs10, obs11, obs12))

observers2<-data.frame(cbind(obs1,obs2,obs3, obs4, obs5, obs6, obs7, obs8, obs9, obs10, obs11, obs12))

observers<-list(observers1, observers2)
names(observers) <-c("obs1", "obs2")
```
###primary model
```{r}
umf1 <- unmarkedMultFrame(y = sampling.ocup1, 
                            siteCovs = data.frame(sampling.cov), 
                            yearlySiteCovs=data.frame(temps),
                            obsCovs=observers, numPrimary=3)
```
##Dynamic model
first term static variables
second term colonization (variable)
third extintion (variable)
detection (observer)
###the best model should take into acount v.1 and v.2, but not v.3, it shouldn't take into acount observers

```{r}
model1 <- colext(~v.1+v.2+v.3, ~1, ~1, ~1, umf1)

model2 <- colext(~1, ~1, ~1, ~1, umf1)

model3 <- colext(~v.1+v.2, ~1, ~1, ~1, umf1) #this should be the best model
model1
model2
model3

```

#APENDIX

##Apendix 1

```{r,echo=FALSE, cache=FALSE}
library("knitr", lib.loc="~/R/win-library/3.2")
kable(df.values, digits=2, col.names=c("Long", "Lat", "Height", "Fire Interval", "Distance to Road", "Sage Stage", "Distance to Water", "ID"), caption="Values recorded for each selected sampling point toghether with it's ID")
```

```{r}
slope<-terrain(topo, opt=c("slope"), unit= "degrees",neighbors=8)
plot (slope)
summary(slope)
slope[slope > 20] <- NA
slope.20<-slope*PNF
plot(slope.20,colNA="black")
slope[slope > 18] <- NA
slope.18<-slope*PNF
plot(slope.18,colNA="black")
slope[slope > 15] <- NA
slope.15<-slope*PNF
plot(slope.15,colNA="black")

slope[slope > 10] <- NA
slope.10<-slope*PNF
plot(slope.10,colNA="black")
```